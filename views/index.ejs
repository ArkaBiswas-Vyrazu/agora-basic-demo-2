<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora API Test</title>
</head>

<body>
    <% if (locals.user) { %>
        <h1>Welcome, <%= locals.user.name %> </h1>
        <a href="/user/logout" style="display: block;">Logout</a>

        Check out these users. You can subscribe to any one if you please. After subscription, you can then view channels that
        the host is currently live streaming on. Click on a channel name to join the stream.

        <ul id="users"></ul>
    <% } else { %>
        <h1>How did you get here?</h1>
        <a href="/user/login">Go to the login page</a>
    <% } %>

    <script defer>
        const usersList = document.querySelector("#users");
        fetch(`http://${window.location.hostname}:${window.location.port}/user/list`)
        .then(async (response) => {
            let users = await response.json();
            let logged_in_user = await fetch(`http://${window.location.hostname}:${window.location.port}/user/logged_in`).then(async response => {
                let data = await response.json();
                return data;
            });

            console.log(`User ====> `, logged_in_user.toString());
            for (const user of users) {
                const listElement = document.createElement("li");
                listElement.textContent = user.name;

                if (!user.is_subscribed) {
                    const subscribeForm = document.createElement("form")
                    subscribeForm.id = `user_subscribe_${user.uuid}`;
                    subscribeForm.class = "user_subscribe";
                    subscribeForm.method = "post";
                    subscribeForm.action = `http://${window.location.hostname}:${window.location.port}/user/subscribe`

                    const hostInputElement = document.createElement("input");
                    hostInputElement.type = "hidden";
                    hostInputElement.name = "host";
                    hostInputElement.value = user.uuid;

                    const subscriberInputElement = document.createElement("input")
                    subscriberInputElement.type = "hidden";
                    subscriberInputElement.name = "subscriber";
                    subscriberInputElement.value = logged_in_user.uuid;

                    const submitButton = document.createElement("button")
                    submitButton.type = "submit";
                    submitButton.textContent = "Subscribe";

                    subscribeForm.appendChild(hostInputElement);
                    subscribeForm.appendChild(subscriberInputElement);
                    subscribeForm.appendChild(submitButton);

                    listElement.appendChild(subscribeForm);
                }

                usersList.appendChild(listElement);
            }
        });
    </script>
</body>

</html>